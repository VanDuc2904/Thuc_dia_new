<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 3: Chọn chủ đề cho đoạn văn</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h2 {
            text-align: center;
        }

        h3 {
            margin-top: 30px;
            color: #333;
        }

        .topic-selector {
            text-align: center;
            margin-bottom: 20px;
        }

        .topic-selector label {
            font-size: 16px;
            margin-right: 10px;
        }

        .topic-selector select {
            padding: 5px;
            font-size: 16px;
        }

        .sentence {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .sentence.show {
            opacity: 1;
            transform: translateY(0);
        }

        .sentence p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        select {
            padding: 5px;
            font-size: 16px;
        }

        .correct-answer {
            color: green;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .hidden {
            display: none;
        }

        #result {
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
        }

        .buttons {
            text-align: center;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #topics {
            transition: opacity 0.3s ease;
        }

        #reset-counter {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }

        .loading {
            text-align: center;
            font-size: 16px;
            color: #555;
        }
    </style>
</head>
<body>
    <h2>Part 3: Chọn chủ đề cho đoạn văn</h2>
    <div class="topic-selector">
        <label for="topic-select">Chọn chủ đề: </label>
        <select id="topic-select" onchange="loadTopic()">
        </select>
    </div>
    <div id="topics"></div>
    <div class="buttons">
        <button onclick="checkAnswers()">Kiểm tra</button>
        <button onclick="showCorrectAnswers()">Xem đáp án</button>
        <button onclick="reset()">Thử lại</button>
        <button onclick="nextTopic()" id="next-topic" class="hidden">Chủ đề tiếp theo</button>
    </div>
    <p id="result"></p>
    <p id="reset-counter">Số lần reset: 0</p>

    <script>
        console.log("Script started at", new Date().toLocaleString());

        const topics = [
            {
                title: "Charles Dickens",
                sentences: [
                    { sentence: "The popularity of Dickens's works in our time remains a global phenomenon.", topic: "Dickens for Our Time" },
                    { sentence: "Shakespeare’s plays are difficult to understand and sometimes require the reader to struggle or think twice to figure out the character’s thoughts.", topic: "Difficulties for Modern Readers" },
                    { sentence: "Hamlet is a Renaissance tragedy written by Shakespeare. The play is very long and has plot twists that keep the reader guessing.", topic: "Keep the Reader Guessing" },
                    { sentence: "Dickens’ legacy is undeniable. His works have been translated and used in over 100 countries and are studied by most schoolchildren in the world.", topic: "The Influence of the Media" },
                    { sentence: "Dickens achieved success at a young age. His first novel, The Pickwick Papers, was published when he was only 24 and became a bestseller.", topic: "Dickens' Early Success" },
                    { sentence: "As Dickens's reputation grew, the question arose whether to preserve his legacy and make it live on. Dickens himself was always keen to make his mark and to maintain his uniqueness.", topic: "Trying to Protect His Property" },
                    { sentence: "To mark the 400th anniversary of Dickens’ death, there will be a number of events to help readers, and especially students, better understand his works.", topic: "Bring the Books to Life" }
                ]
            },
            {
                title: "William Shakespeare",
                sentences: [
                    { sentence: "Shakespeare’s works are performed worldwide in theaters and festivals.", topic: "Global Popularity" },
                    { sentence: "His plays often explore complex themes like love, power, and betrayal.", topic: "Complex Themes" },
                    { sentence: "Many of Shakespeare’s words and phrases are still used in modern English.", topic: "Linguistic Influence" },
                    { sentence: "Reading Shakespeare requires understanding Elizabethan English, which can be challenging.", topic: "Language Challenges" }
                ]
            }
        ];

        console.log("Topics loaded:", topics);

        let currentTopicIndex = 0;
        let shuffledSentences = [];
        let resetCount = 0;
        let lastSentenceOrder = null;

        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[i], shuffled[j]];
            }
            return shuffled;
        }

        function arraysEqual(arr1, arr2) {
            if (!arr1 || !arr2 || arr1.length !== arr2.length) return false;
            return arr1.every((item, index) => item.sentence === arr2[index].sentence);
        }

        function loadTopicSelector() {
            console.log("Loading topic selector");
            const topicSelect = document.getElementById("topic-select");
            topicSelect.innerHTML = "";
            topics.forEach((topic, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = topic.title;
                topicSelect.appendChild(option);
            });
            topicSelect.value = currentTopicIndex;
        }

        function loadTopic() {
            console.log("Loading topic:", currentTopicIndex, "at", new Date().toLocaleString());
            currentTopicIndex = parseInt(document.getElementById("topic-select").value);
            const topic = topics[currentTopicIndex];

            console.log("Before shuffle - Original sentences order:", topic.sentences.map(item => item.sentence));
            
            let attempts = 0;
            const maxAttempts = 50;
            do {
                shuffledSentences = shuffle([...topic.sentences]);
                attempts++;
                if (attempts >= maxAttempts) {
                    console.warn("Max shuffle attempts reached. Using last shuffled order.");
                    break;
                }
            } while (
                lastSentenceOrder && 
                shuffledSentences.length > 1 && 
                arraysEqual(shuffledSentences, lastSentenceOrder)
            );

            lastSentenceOrder = [...shuffledSentences];
            console.log("After shuffle - Shuffled sentences order:", shuffledSentences.map(item => item.sentence));
            console.log("First sentence:", shuffledSentences[0]?.sentence);

            const topicsDiv = document.getElementById("topics");
            topicsDiv.innerHTML = `<h3>Part 3: Topic: ${topic.title}</h3>`;
            
            const topicOptions = topic.sentences.map(item => item.topic);
            console.log("Topic options:", topicOptions);
            
            shuffledSentences.forEach((item, index) => {
                const shuffledTopicOptions = shuffle(topicOptions);
                console.log(`Shuffled options for sentence ${index + 1}:`, shuffledTopicOptions);
                const randomId = Math.random().toFixed(4);
                const div = document.createElement("div");
                div.className = "sentence";
                div.id = `sentence-${index}-${randomId}`;
                div.innerHTML = `
                    <p>Đoạn ${index + 1} (ID: ${randomId}): "${item.sentence}"</p>
                    <select id="select-${index}-${randomId}">
                        <option value="">Chọn chủ đề</option>
                        ${shuffledTopicOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                    <p class="correct-answer" id="correct-${index}-${randomId}"></p>
                `;
                topicsDiv.appendChild(div);
            });

            setTimeout(() => {
                document.querySelectorAll(".sentence").forEach((el, i) => {
                    setTimeout(() => {
                        el.classList.add("show");
                    }, i * 100);
                });
            }, 50);

            document.getElementById("next-topic").classList.add("hidden");
            document.getElementById("result").textContent = "";
            document.getElementById("reset-counter").textContent = `Số lần reset: ${resetCount}`;
        }

        function checkAnswers() {
            console.log("Checking answers");
            const result = document.getElementById("result");
            let allCorrect = true;
            let allSelected = true;

            shuffledSentences.forEach((item, index) => {
                const select = document.querySelector(`select[id^="select-${index}-"]`);
                const correctAnswer = document.querySelector(`p[id^="correct-${index}-"]`);
                const userAnswer = select.value;

                if (!userAnswer) {
                    allSelected = false;
                }

                if (userAnswer !== item.topic) {
                    allCorrect = false;
                    correctAnswer.textContent = `Đáp án đúng: ${item.topic}`;
                    correctAnswer.style.display = "block";
                } else {
                    correctAnswer.textContent = "";
                    correctAnswer.style.display = "none";
                }
            });

            if (!allSelected) {
                result.textContent = "Vui lòng chọn đáp án cho tất cả các đoạn!";
                result.style.color = "red";
                return;
            }

            if (allCorrect) {
                result.textContent = "Đúng hết! Chúc mừng bạn!";
                result.style.color = "green";
                document.getElementById("next-topic").classList.remove("hidden");
            } else {
                result.textContent = "Có đoạn sai, xem đáp án và thử lại nhé!";
                result.style.color = "red";
            }
        }

        function showCorrectAnswers() {
            console.log("Showing correct answers");
            shuffledSentences.forEach((item, index) => {
                const correctAnswer = document.querySelector(`p[id^="correct-${index}-"]`);
                correctAnswer.textContent = `Đáp án đúng: ${item.topic}`;
                correctAnswer.style.display = "block";
            });
        }

        function nextTopic() {
            console.log("Moving to next topic");
            currentTopicIndex = (currentTopicIndex + 1) % topics.length;
            document.getElementById("topic-select").value = currentTopicIndex;
            resetCount = 0;
            lastSentenceOrder = null;
            reset();
            loadTopic();
        }

        function reset() {
            console.log("Resetting at", new Date().toLocaleString());
            resetCount++;
            document.getElementById("result").textContent = "";
            const topicsDiv = document.getElementById("topics");
            topicsDiv.style.opacity = "0";
            setTimeout(() => {
                topicsDiv.innerHTML = `<p class="loading">Đang xáo trộn...</p>`;
                setTimeout(() => {
                    loadTopic();
                    topicsDiv.style.opacity = "1";
                }, 500);
            }, 300);
        }

        console.log("Initializing");
        loadTopicSelector();
        loadTopic();
    </script>
</body>
</html>
